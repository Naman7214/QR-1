<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
        crossorigin="anonymous"></script>
</head>

<style>
    /* Add a custom class for narrower table */
    .narrow-table {
        width: 60%; /* Adjust the width as needed */
        margin: auto; /* Center the table */
        border: 1px solid black;
    }

    .border {
        border: 6px solid black;
        margin-top: 3rem;

    }

    .design {
        display: flex;
        gap: 13em;
        align-items: center;
        justify-content: center;
    }
    .modal {
        display: none;
        position: fixed;
        z-index: 1;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0,0,0,0.9);
        padding-top: 60px;
        text-align: center;
      }
  
      .modal-content {
        margin: auto;
        display: block;
        width: 80%;
        max-width: 600px;
        background-color: #fefefe;
        padding: 20px;
        border-radius: 5px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      }
  
      #modalClose {
        color: #ccc;
        float: right;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
      }
  
      .modal-header {
        padding: 2px 16px;
        background-color: #5cb85c;
        color: white;
        border-radius: 5px 5px 0 0;
      }
  
      .modal-body {
        padding: 16px;
      }
      .toggle-button {
        margin-top: 0.5rem;
    }

</style>

<body>
    <div>
        <nav class="navbar sticky-top navbar-expand-lg bg-body-tertiary bg-dark" data-bs-theme="dark">
            <div class="container-fluid">
                <a class="navbar-brand" href="/admin_options">ITATS Dashboard</a>
                <div class="collapse navbar-collapse" id="navbarSupportedContent">
                    <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                    </ul>
                    <ul class="navbar-nav">
                        <li class="nav-item">
                            <button class="btn" id="adminProfile" onclick="openAdminProfileModal()">
                                <img src="/static/icon-1633249_1280.png" alt="Admin" height="40px"
                                    style="filter: invert();">
                            </button>
                            <div id="profileModal" class="modal">
                                <div class="modal-content">
                                    <span id="modalClose" onclick="closeProfileModal()">&times;</span>
                                    <h2>Admin Profile</h2>
                                    <div id="modalProfileText">Loading profile...</div>
                                </div>
                            </div>
                        </li>
                    </ul>
                </div>
            </div>
        </nav>

        <div class="container">
            <div class="border">
                <form method="post" action="/admin_dashboard">
                    <div class="design">
                        <div>
                            <label for="subject_name">Subject Name:</label>
                            <select id="subject_name" name="subject_name" required>
                                <option value="WAD">WAD</option>
                                <option value="DSBDA">DSBDA</option>
                                <option value="CC">CC</option>
                                <option value="CNS">CNS</option>
                                <option value="CS">CS</option>
                                <!-- Add more subjects as needed -->
                            </select>
                        </div>
                        <div>
                            <label for="time_slot">Time Slot:</label>
                            <select id="time_slot" name="time_slot" required>
                                <option value="9:00 - 10:00">9:00 - 10:00</option>
                                <option value="10:00 - 11:00">10:00 - 11:00</option>
                                <option value="11:15 - 12:15">11:15 - 12:15</option>
                                <option value="12:15 - 1:15">12:15 - 1:15</option>
                                <option value="2:00 - 3:00">2:00 - 3:00</option>
                                <option value="3:00 - 4:00">3:00 - 4:00</option>
                                <!-- Add more time slots as needed -->
                            </select>
                        </div>
                        <div>
                            <label for="date">Date:</label>
                            <input type="date" id="date" name="date" required>
                        </div>
                        <div>
                            <button onclick="" class="btn-success btn">GO</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
        <div>
            {% if no_records_found %}
            <p>No records found for the specified criteria.</p>
            {% else %}

            <!-- Apply the custom class to the table -->
            <table class="table table-striped narrow-table">
                <thead>
                    <tr>
                        <th>Roll No</th>
                        <th>Student Name</th>
                        <th>Subject</th>
                        <th>Date</th>
                        <th>Time</th>
                        <th>Attendance</th>
                        <th>Action</th> <!-- Added header for the action column -->
                    </tr>
                </thead>
                <tbody>
                    {% for record in records %}
                    <tr>
                        <td>{{ record['rollno'] }}</td>
                        <td>{{ record['stdname'] }}</td>
                        <td>{{ record['subject'] }}</td>
                        <td>{{ record['date'] }}</td>
                        <td>{{ record['time'] }}</td>
                        <td>{{ record['attendance'] }}</td>
                        <!-- Move the button column to the beginning of the row -->
                        <td>
                            <button class="btn btn-sm btn-warning toggle-button"
                                onclick="updateAttendance('{{ record['rollno'] }}', '{{ record['subject'] }}', '{{ record['date'] }}', '{{ record['time'] }}', '{{ record['attendance'] }}')">Toggle
                                Attendance</button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% endif %}
        </div>
        <div class="text-center mt-3">
            <button class="btn btn-primary" onclick="downloadAttendance()">Download Attendance</button>
        </div>
    </div>
</body>

<script>
    function updateAttendance(rollno, subject, date, time, attendance) {
        // Make an AJAX request to update the attendance
        fetch('/update_attendance', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                rollno: rollno,
                subject: subject,
                date: date,
                time: time,
                attendance: attendance,
            }),
        })
            .then(response => response.json())
            .then(data => {
                // Handle the response, you can update the UI accordingly
                console.log(data);
                // Reload the page or update the specific row in the UI
                location.reload();
            })
            .catch(error => {
                console.error('Error:', error);
            });
    }

    function getAdminProfile() {
        var xhr = new XMLHttpRequest();
        xhr.open("GET", "/admin_profile", true);
        xhr.onreadystatechange = function () {
            if (xhr.readyState == 4) {
                if (xhr.status == 200) {
                    var adminProfile = JSON.parse(xhr.responseText);

                    // Display admin profile information
                    document.getElementById('modalProfileText').innerText = 'Admin: ' + adminProfile.admin_username + ', Dept: ' + adminProfile.admin_dept + ', Class: ' + adminProfile.admin_class;
                } else {
                    console.error('Failed to retrieve admin profile');
                }
            }
        };
        xhr.send();
    }

    // Function to open the admin profile modal
    function openAdminProfileModal() {
        getAdminProfile();  // Update admin profile before opening modal
        var modal = document.getElementById('profileModal');
        modal.style.display = 'block';
    }

    // Function to close the admin profile modal
    function closeProfileModal() {
        var modal = document.getElementById('profileModal');
        modal.style.display = 'none';
    }

    // Initialize the admin profile
    function initializeAdminProfile() {
        console.log('Initializing Admin Profile...');
        getAdminProfile();
    }
    function downloadAttendance() {
        // Get the table data
        var table = document.querySelector('.narrow-table');
        var rows = Array.from(table.querySelectorAll('tr'));
    
        // Create a CSV content
        var csvContent = '';
    
        // Iterate through rows and columns
        rows.forEach(function (row, rowIndex) {
            var columns = Array.from(row.querySelectorAll('td, th'));
    
            // Skip the action column (last column)
            if (rowIndex > 0) {
                columns.pop();
            }
    
            var rowArray = columns.map(function (column) {
                // Format date cells to prevent ######### issue
                return (column.cellIndex === 3) ? formatExcelDate(column.innerText) : column.innerText;
            });
    
            csvContent += rowArray.join(',') + '\n';
        });
    
        // Create a blob and initiate download
        var blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        var link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = "attendance_sheet.csv";
        document.body.appendChild(link);
        link.click();
    }
    
    // Function to format date cells for CSV
    function formatExcelDate(dateString) {
        var date = new Date(dateString);
        return date.toLocaleDateString('en-US', { year: 'numeric', month: '2-digit', day: '2-digit' });
    }
    

    // Call the initialization function
    initializeAdminProfile();
</script>

</html>